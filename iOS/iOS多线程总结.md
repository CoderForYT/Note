# iOS多线程总结

## 目的

本文将从一下几个各方面分享多线程的的相关内容：

1. 多线程的基本概念
2. 多线程的状态和生命周期
3. iOS提供的四种解决方案：pthread, NSThread, GCD, NSOperation
4. NSThread 的使用
5. CGD的理解和使用
6. NSOperation的理解和使用
7. GCD和NSOperation对比
8. 线程安全

## 1. 多线程的基本概念

​	我们都知道，进程是运转中的程序，是为了在CPU上实现多道线程而发明的概念，但是进程在同一时间只能处理一件事，如果我们需要同时处理两件或者两件以上的事情，就需要使用到线程。

### 1.1 进程的概念 

​	进程是一个具有一定独立功能的程序关于某个数据集合的一次运行活动，它是操作系统动态执行的基本单元。在传统的操作系统中，进程即使基本的分配单元，也是基本的执行单元。

​	进程的概念有两点：第一，进程是一个实体，每个进程有自己的地址空间，包括文本区域（text region），数据区域（data region），堆栈。第二，进程是一个“执行中的的程序”。程序是没有生命的实体，只有处理器赋予程序生命时（执行），它才能成为一个活动的尸体，称之为进程。

​	在iOS中，可以认为一个App都有一个对应的进程，App并不能操作进程。

### 1.2 线程的概念

​	每个正在系统运行的程序都是一个进程，每个进程包含一到多个线程。进程也可能是整个程序或者部分程序的动态执行。线程是一组指令的集合，或者是程序的特殊段。它能在程序里独立执行。也可以把它理解为代码运行的上下文。所以基本上是轻量级的进程，他负责在单个程序里执行多个程序。通常有操作系统负责多个线程的调度和执行。

### 1.3 多线程的概念

​	多线程是指从软件或者硬件上实现多个线程并发执行的技术。多线程是为了完成同步完成多项任务，不是为了提高运行效率。多线程是通过提高资源使用率来提高系统的总体性能。

## 2. 多线程的状态和生命周期

​	下图是多线程状态示意图。线程的生命周期包括：新建，就绪，运行，阻塞，死亡。![多线程的状态](http://cc.cocimg.com/api/uploads/20170707/1499394752139363.png)

* 新建（NEW）：实例化线程对象
* 就绪（Runnable）：向线程对象发送start命令，线程多项被加入到可调度的线程池，等待CPU调度。
* 运行（Running）：CPU负责调度可调度线程池中线程的执行。线程执行完成前，状态可能会在就绪和运行之间来回切换。就绪和运行之间的状态变化由CPU负责。不能进行干预。
* 阻塞：（Blocked）：当满足某个预订条件时，可以使用休眠或者锁，阻塞线程执行。sleepForTimeInterval（休眠指定时长），sleepUntileDate（休眠到指定日期），@synchronized（self）（互斥锁）。
* 死亡：正常死亡：线程执行完毕。非正常死亡，当满足某个条件后，在线程内部中止执行，或者在主线程终止。

## 3. iOS提供的四种解决方案：pthread, NSThread, GCD, NSOperation

​	iOS提供了四种解决方案，分别是：pthread, NSThread, GCD, NSOperation。

​	下面的图是对四种方案的总结。

![iOS提供的多线程解决方案](http://cc.cocimg.com/api/uploads/20170707/1499394732413995.png)

## 4. NSThread 的使用(API)

### 4.1 线程创建方式

```
- init
- initWithTarget:selector:object:
```

### 4.2 开始执行线程

```objective-c
+ detachNewThreadSelector:toTarget:withObject:
- start
- main
```

### 4.3 停止, 阻塞线程

```objective-c
+ sleepUntilDate:
+ sleepForTimeInterval:
+ exit
- cancel
```

### 4.4 状态

```objective-c
executing
finished
cancelled
```

### 4.5 主线程相关

```objective-c
isMainThread
mainThread
```

## 5. CGD的理解和使用

​	GCD, 全称Grand Central Dispatch，是苹果为多核心处理器开发的一套异步调度机制。苹果官方文档中是这样介绍它的：

```
Grand Central Dispatch (GCD) comprises language features, runtime libraries, and system enhancements that provide systemic, comprehensive improvements to the support for concurrent code execution on multicore hardware in iOS and OS X.
```

​	GCD能够合理地利用更多的CPU内核，最重要的是它会自动管理线程的生命周期（创建线程，调度任务，销毁线程），完全不需要我们进行管理了，加上虽然使用的是C语言，但是使用了大部分使用了Block，使用起来更加方便，减轻了开发者多线程开发的难度。

### 5.1 两个基本概念

​	在GCD中有两个非常重要的概念：任务和队列。这也是GCD的核心。

#### * 任务

​	任务值得是操作的意思。换句话就是你需要在线程执行的代码。在GCD中，任务是放在block中的。

​	执行任务有两种方式：同步（sync）和异步（async）。**同步和异步的主要区别在于是否阻塞当前线程。**

 * 同步执行（sync）：
    * 在当前线程中执行任务，不具备开启新线程的能力。
    * 同步添加到指定的队列中，在新添加的任务执行完成之前，会一直阻塞（等待），直到队列中的任务完成之后，才会继续执行
* 异步执行（async）：
  * 另开一条线程执行任务。
  * **具备开启新线程的能力**，会在新的线程中执行新的任务，当前线程并不会受到任何影响。
  * 异步执行虽然具备开启线程的能力，但是并不一定开启新线程，这取决于**队列**的类型。

#### * 队列

​	这里的队列指的执行任务的等待队列，即用来存放任务的队列。队列是一种特殊的线性表，采用先进先出（FIFO）的原则。即新任务总是被插入到队列的末尾，而读取任务的时候总是从队列的头部开始读取。GCD有两种类型的队列：串行队列和并发队列。**两者最主要的区别是：执行顺序不同，以及开启的线程数不同。**

 * 串行队列
    * 每次只有一个任务被执行。只有任务处理结束，才会从队列中移除。一次只会用到一个线程。
 * 并发队列
   * 不需要等待任务处理结束，所以可以同时执行多个任务。但是并行执行的处理数量取决于当前系统的状态。所谓并行执行，就是使用多个线程同时执行多个任务。

#### * 总结

​	综合以上任务和队列的组合，加上主线程是特殊的串行队列，可以总结出一下的表

|     区别      |    并发队列（concurrent）    |                      串行队列（serial）                      |                            主队列                            |
| :-----------: | :--------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| 同步（sync）  | 没有开启新线程，串行执行任务 | 当前线程调用：**死锁**     <br /> 其他线程调用：没有开启新线程，串行执行任务 | 主线程调用：**死锁**   <br />其他线程调用：没有开启新线程，串行执行任务 |
| 异步（async） |  有开启新线程，并发执行队列  |               有开启新线程(1条)，串行执行任务                |                 没有开启新线程，串行执行任务                 |

​      PS：Q： 为什么在主队列或者在当前线程调用串行同步队列会引起死锁？ 

​		A：原因是同步任务的特点是：添加一个新的同步任务，会先阻塞当前线程，等待新添加的任务执行完成。 而串行队列的特点是：必须等到先添加的任务执行完成，才会执行新添加的任务。如果在主队列，或者当前线程调用串行同步队列，就会造成原有的任务等待新添加的任务完成，而新添加的任务等待原有任务的完成，造成相互等待，形成死锁。



## 6. NSOperation的理解和使用

## 7. GCD和NSOperation对比

## 8. 线程安全

## 9. 参考来源

1. 进程： https://baike.baidu.com/item/进程/382503
2. 多线程： https://baike.baidu.com/item/多线程/1190404
3. 关于iOS多线程，你看我就够了： https://www.jianshu.com/p/0b0d9b1f1f19